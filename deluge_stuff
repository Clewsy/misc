#docs:
# https://deluge.readthedocs.io/en/latest/how-to/systemd-service.html

#1
#For a headless install with webui and console ui:
sudo apt-get install deluged deluge-webui deluge-console

#2
#Make the daemon run at boot:
#deluge guide: https://dev.deluge-torrent.org/wiki/UserGuide/Service/systemd

#2.1
#User management
#create the system user and group "deluge"
sudo adduser --system --gecos "Deluge Service" --disabled-password --group --home /var/lib/deluge deluge
#add users to "deluge" group as required
sudo adduser b4t deluge

#2.2 if required
#Migrate from init.d to systemd
#Remove any old init.d scripts damed deluge-daemon
sudo /etc/init.d/deluge-daemon stop
sudo rm /etc/init.d/deluge-daemon
sudo update-rc.d deluge-daemon remove

#2.3
#Create systemd service
sudo vim /etc/systemd/system/deluged.service
#Input the following:
#######################################################
[Unit]
Description=Deluge Bittorrent Client Daemon
Documentation=man:deluged
After=network-online.target

[Service]
Type=simple
UMask=007

ExecStart=/usr/bin/deluged -d

Restart=on-failure

# Time to wait before forcefully stopped.
TimeoutStopSec=300

[Install]
WantedBy=multi-user.target
#######################################################
#Notes about "UMask" option:
# 007 grants full access to the user and members of the group deluged is running as (in this case deluge) and prevents access from all other accounts.
# 022 grants full access to the user deluged is running as and only read access to other accounts.
# 002 grants full access to the user and group deluged is running as and only read access to other accounts.
# 000 grants full access to all accounts.
#Now enable start at boot:
sudo systemctl enable /etc/systemd/system/deluged.service
sudo systemctl start deluged
sudo systemctl status deluged
#Now similar setup to enable deluge-webui
sudo vim /etc/systemd/system/deluge-web.service
#Input the following:
##########################################################
[Unit]
Description=Deluge Bittorrent Client Web Interface
Documentation=man:deluge-web
After=network-online.target deluged.service
Wants=deluged.service

[Service]
Type=simple
UMask=027

ExecStart=/usr/bin/deluge-web -d

Restart=on-failure

[Install]
WantedBy=multi-user.target
##########################################################
#Also note "User=deluge" changed to "User=b4t" for my purposes to simplify access via deluge-console.
#Now enable and start
sudo systemctl enable /etc/systemd/system/deluge-web.service
sudo systemctl start deluge-web
sudo systemctl status deluge-web

##Use default port 8112 to login to deluge - default password is "deluge"


